
```{r warning = FALSE, message = FALSE}
options(shiny.maxRequestSize = 30*1024^2)

library(shiny)
library(shinydashboard)
library(DT)
library(ggplot2)
library(dplyr)
library(Jmisc)
library(msm)
library(gt)
library(leaflet)

sourceAll("./Functions")

ui <- dashboardPage(
  dashboardHeader(title = "D4T4 V1S in RShiny"),
  
  dashboardSidebar(
    sidebarMenu(
      menuItem("Homepage", tabName = "hp", icon = icon("home")),
      menuItem("Import Dataset", tabName = "i", icon = icon("arrow-circle-up")),
      menuItem("Edit Dataset", tabName = "e", icon = icon("pencil-ruler")),
      menuItem("Filter Dataset", tabName = "f", icon = icon("filter")),
      menuItem("Plots", tabName = "p", icon = icon("chart-area")),
      menuItem("Markov Matrices", tabName = "mm", icon = icon("border-none"))
    )
  ),
  
  dashboardBody(
    tabItems(
      tabItem(tabName = "hp", 
              column(width = 12,
                     h3("Welcome to D4T4 V1S in R Shiny, an introductory application
                designed to accelerate the process of synthesizing reports
                and visualizations about data in easy-to-understand graphics
                and explanations."),
                h3("The additional tabs in the menu will direct users to the 
                functionality within this appliaction."),
                h3("Note: This application may appear odd on some computers with respect to 
                   orientation; monitors and such may have a different resolution than computers
                   and thus may disorient some of the graphics. As these are discovered, user-defined 
                   settings will be included to make the UI more user-friendly."),
                
                h2("To-Do: "),
                h4("Import w/ File Input. (Completed at basic level.)"),
                h4("Scrollable Visualization w/ DT, formattable (Completed)"),
                h4("Dynamic Filtering (Doing now...ish)"),
                h4("Univariate and Bivariate Plots w/ ggplot2"),
                h4("Markov Chain Matrix widget"),
                h4("Strikezone Plots for Contact, Progression, by Pitch Type"),
                h4("Include Other Project Functions Datasets can be run through."),
                h4("Exports and Saves for Images, Charts, etc. --> Prep. of LaTeX report?")
              ) 
      ), 
      
      tabItem(tabName = "i", 
              column(width = 6, 
                     textOutput("fileIO_1"),
                     checkboxInput("header1", "Header in File?", TRUE),
                     
                     fileInput("infile1", "Choose .csv File", 
                               accept = c(".csv"))
              )
              ,
              column(width = 12, 
                     h2("View File Output: "),
                     DT::dataTableOutput("infile1_dt"), 
                     style = "height:350px; overflow-y: scroll;overflow-x: scroll;")
      ),
      
      tabItem(tabName = "e",
              textOutput("edit_msg"),
              
              h3("Specify Required Variables: "),
              
              fluidRow(
                column(width = 4,
                       selectInput("date_var", "Select \"Date\" Variable: ",
                                   choices = NULL),
                       selectInput("events_var", "Select \"Events\" Variable (e.g., Single, Double, Groundout, etc.): ", choices = NULL),
                       selectInput("description_var", "Select \"Description\" Variable (e.g., swinging-strike, hit, etc.): ", choices = NULL)
                ),
                column(width = 4, offset = 1,
                       selectInput("away_team_var", "Select \"Away Team\" Variable: ",
                                   choices = NULL),
                       selectInput("home_team_var", "Select \"Home Team\" Variable: ",
                                   choices = NULL),
                       selectInput("launch_speed_var", "Select \"Launch Speed (Exit Velo)\" Variable", choices = NULL)
                )
              ),
              fluidRow(
                column(width = 10,
                       actionButton("id_create", "Create IDs", icon = icon("asymmetrik")),
                       actionButton("swing_matrix_create", "Create Contact & Swing Matrix Vars", icon = icon("bolt"))
                )
              ),
              fluidRow(
                column(width = 10,
                       textInput("exp_filename", "Filename to Save: ", placeholder = "export1.csv"),
                       actionButton("edited_table_save", "Export Table to .csv", icon = icon("share-alt"))
                )
              ),
              
              dataTableOutput("edited_table")
      ),
      
      tabItem(tabName = "f", 
              textOutput("filter_msg"),
              textOutput("d_in_use"),
              
              h2("Select Filter Variables:"),
              
              sidebarPanel(
                h3("Pitch Types"),
                selectInput("pt_filter_var", "Select \"Pitch Type\" Variable: ",
                            choices = NULL),
                
                h3("Hard/Soft Contact & Swing-With-Miss"),
                selectInput("c_swm_filter_var", "Select \"Hard/Soft Contact & Miss\" Variable: ",
                            choices = NULL),
                
                
              ),
              
              mainPanel(
                h2("Pitch Type Filtering: "),
                uiOutput("pt_filter"),
                
                h2("Hard/Soft Contact Filtering: "),
                h4("Note: Make sure the imported dataset has been run through the 
                  swingMatrixStates.R function."),
                uiOutput("c_swm_filter")
              )
      ),
      
      tabItem(tabName = "p", 
              h4("Plot widget for creating univariate and bivariate plots. Select the variable(s) needed, pay attention to their types, and then choose the plot from the Plot dropdown."),
              
              fluidRow(
                column(3,
                       h3("Use Filters?"),
                       checkboxInput("pt_filter_bool", "Use Pitch Type Filter?", value = TRUE),
                       checkboxInput("c_swm_filter_bool", "Use Contact Filter?", value = TRUE),
                ),
                column(3,
                       selectInput("plot_dropdown", "Select Plot Type: ", 
                                   c("Scatterplot" = "point",
                                     "Histogram" = "hist", 
                                     "Barplot" = "bar",
                                     "2-D Bin Plot" = "bin2d",
                                     "Density/Violin Plot" = "violin")),
                       textInput("plot_filename", "Plot Filename: ", placeholder = "Test1.png"),
                       actionButton("plot_save", "Save Plot as .png", icon = icon("file-export"))
                ),
                column(3,
                       selectInput("plot_x", "Select X Variable: ",
                                   choices = NULL),
                       selectInput("plot_y", "Select Y Variable: ", 
                                   choices = NULL)
                ),
                column(3,
                       textInput("plot_title", "Plot Title: ", placeholder = "No title given."),
                       textInput("plot_caption", "Plot Caption: ", placeholder = "No caption given.")),
                
                
                
                
                
                plotOutput("plot1")
              )
      ),
      
      tabItem(tabName = "mm",
              textOutput("markov_msg"),
              
              sidebarLayout(
                sidebarPanel = sidebarPanel(
                  tabsetPanel(
                    tabPanel(
                      "Variables",
                      h4("Decide what variable represents the foundation of the model (i.e. what is 
             shifting and changing from observation to observation?"),
             selectInput("markov_states_var", "Select \"State\" Variable: ",
                         choices = NULL),
             h4("Decide what variable divides between cases, such as an ID that signals a new 
               at-bat."),
             selectInput("markov_divider_var", "Select \"Divider\" Variable: ",
                         choices = NULL),
                    ),
             
             tabPanel(
               "Descriptors",
               textInput("markov_title", "Title: ", value = "Markov Transition Matrix"),
               textInput("markov_subtitle", "Subtitle: ", value = "More Specific Info Here"),
               textInput("markov_caption", "Caption: ", value = "Key for Abbreviations Here"),
               textInput("markov_outfile", "Filename to Save (.html): ", value = "myMarkov1.html"),
               actionButton("markov_save", "Save Table as .html", icon = icon("file-export"))
             )
                  )
                ),
             
             mainPanel = mainPanel(
               gt_output("markov1")
             )
        )
      )
    )
  )
)

server <- function(input, output, session) {
  
  values <- reactiveValues(table1 = NULL,
                           plotChoice = NULL,
                           df = NULL,
                           markov = NULL)
  
  data <- reactive({
    if1 = input$infile1
    if (is.null(if1)) {
      return(NULL)
    }
    
    df <- read.csv(if1$datapath, header = input$header1)
    
    updateSelectInput(session, "pt_filter_var", choices = names(df))
    updateSelectInput(session, "c_swm_filter_var", choices = names(df))    
    updateSelectInput(session, "plot_x", choices = names(df))
    updateSelectInput(session, "plot_y", choices = names(df))
    
    updateSelectInput(session, "date_var", choices = names(df))
    updateSelectInput(session, "home_team_var", choices = names(df))    
    updateSelectInput(session, "away_team_var", choices = names(df))
    updateSelectInput(session, "events_var", choices = names(df))
    updateSelectInput(session, "description_var", choices = names(df))
    updateSelectInput(session, "launch_speed_var", choices = names(df))
    
    updateSelectInput(session, "markov_states_var", choices = names(df))
    updateSelectInput(session, "markov_divider_var", choices = names(df))
    
    return(df)
  })
  
  output$edit_msg <- renderText({
    "Tab for using included functions to add categorical variables that aid in the
    creation of Markov Chain Models, Transition Matrices, plots w/ discrete axes, etc."
  })
  
  observeEvent(input$id_create, {
    d = NULL
    
    if (is.null(values$df)) {
      d = data()
    }
    else {
      d = values$df
    }
    
    values$df = idCreator(d, 
                          d[,colnames(d) == input$date_var],
                          d[,colnames(d) == input$home_team_var],
                          d[,colnames(d) == input$away_team_var],
                          d[,colnames(d) == input$events_var])
    
    updateSelectInput(session, "pt_filter_var", choices = names(values$df))
    updateSelectInput(session, "c_swm_filter_var", choices = names(values$df)) 
    updateSelectInput(session, "plot_x", choices = names(values$df))
    updateSelectInput(session, "plot_y", choices = names(values$df))
  })
  
  observeEvent(input$swing_matrix_create, {
    d = NULL
    
    if (is.null(values$df)) {
      d = data()
    }
    else {
      d = values$df
    }
    
    values$df = swingMatrixStates(d, 
                                  d[,colnames(d) == input$launch_speed_var],
                                  d[,colnames(d) == input$description_var],
                                  d[,colnames(d) == input$pt_filter_var],
                                  90.0, 1.0)
  })
  
  observeEvent(input$edited_table_save, {
    write.csv(values$df, input$exp_filename)
  })
  
  output$edited_table = renderDataTable({
    
    DT::datatable(data.frame(values$df),
                  options = list(paging = FALSE,
                                 scrollX = TRUE, 
                                 scrollY = "375px"))
  })
  
  output$fileIO_1 <- renderText({
    "Import a .csv file here for use with the included widgets."
  })
  
  output$filter_msg <- renderText({
    "Filter widget for working with datasets. Add unique filters as you think of them, 
     or as they fit your needs."
  })
  
  output$d_in_use <- renderText({
    paste("File In Use: ", input$infile1$name)
  })
  
  output$pt_filter <- renderUI({
    if (is.null(values$df)) {
      values$df = data()
    }
    
    ptChoices <-  unique(values$df[,colnames(values$df) == input$pt_filter_var])
    checkboxGroupInput("pt_filter","Select Pitch Type(s): ", choices = ptChoices,
                       selected = ptChoices)
  })
  
  output$c_swm_filter <- renderUI({
    if (is.null(values$df)) {
      values$df = data()
    }
    contactChoices <- unique(values$df[,colnames(values$df) == input$c_swm_filter_var])
    checkboxGroupInput("c_swm_filter", "Select Contact State(s): ", choices = contactChoices,
                       selected = contactChoices)
  })
  
  output$infile1_dt <- renderDataTable({
    
    DT::datatable(data.frame(data()), 
                  options = list(paging = FALSE,
                                 scrollX = TRUE, 
                                 scrollY = "375px")
    )
  }
  )
  
  
  
  output$plot1 <- renderPlot({
    df = data()
    
    if (input$pt_filter_bool) {
      df = df %>% filter(df[,colnames(values$df) == input$pt_filter_var] %in% input$pt_filter)
    }
    if (input$c_swm_filter_bool) {
      df = df %>% filter(df[,colnames(values$df) == input$c_swm_filter_var] %in% input$c_swm_filter)
    }
    
    gg <- NULL
    
    if (input$plot_dropdown == "point") {
      gg <- ggplot(data = df, aes_string(x = input$plot_x, y = input$plot_y)) + geom_point()
    }
    else if (input$plot_dropdown == "hist") {
      gg <- ggplot(data = df, aes_string(x = input$plot_x)) + geom_histogram()
    }
    else if (input$plot_dropdown == "bar") {
      gg <- ggplot(data = df, aes_string(x = input$plot_x)) + geom_bar(stat = "count") 
    }
    else if (input$plot_dropdown == "bin2d") {
      gg <- ggplot(data = df, aes_string(x = input$plot_x, y = input$plot_y)) + geom_bin2d()
    }
    else {
      gg <- ggplot(data = df, aes_string(x = input$plot_x, y = input$plot_y)) + geom_violin()
    }
    
    gg <- gg + labs(title = input$plot_title, 
                    caption = input$plot_caption)
    
    return(gg)
  })
  
  observeEvent(input$plot_save, {
    ggsave(input$plot_filename, width = 20, units = "cm")
  })
  
  output$markov1 <- render_gt({
    
    if (is.null(values$df)) {
      values$df = data()
    }
    
    stateVar <- values$df[,colnames(values$df) == input$markov_states_var]
    dividerVar <- values$df[,colnames(values$df) == input$markov_divider_var]
    
    m1 <- markovTransitionMatrix(values$df, statesVar = stateVar, dividerVar = dividerVar, 
                                 precision = 3,
                                 titleString = input$markov_title, 
                                 subtitleString = input$markov_subtitle, 
                                 captionString = input$markov_caption, 
                                 filenameToSave = input$markov_outfile)
    values$markov = m1$table
    m1$table
    
  },
  height = px(1200),
  width = px(1200)
  )
  
  observeEvent(input$markov_save, {
    fn = ""
    if (".html" %in% input$markov_outfile) {
      fn = input$markov_outfile
    }
    else {
      fn = paste(input$markov_outfile, ".html", sep = "")
    }
    if (is.null(values$markov)) {
      return()
    }
    saveMatrix(values$markov, input$markov_outfile)
  })
  
}

shinyApp(ui, server)
```


